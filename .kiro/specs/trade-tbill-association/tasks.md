# 实施计划

- [x] 1. 修改交易记录数据模型和云函数




  - 为交易记录添加matchStatus字段，默认值为'unmatched'
  - 修改addTrade云函数，移除自动匹配逻辑，设置默认matchStatus
  - 添加updateTradeMatchStatus云函数操作，用于更新交易记录匹配状态
  - 添加checkTradeEditable云函数操作，检查交易记录是否可编辑
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2. 实现交易记录选择相关云函数














  - [x] 2.1 添加getUnmatchedTrades云函数操作


    - 查询指定条件下的未匹配交易记录
    - 支持按股票代码和交易类型筛选
    - _需求: 2.1, 2.2, 2.3_

  - [x] 2.2 添加getMatchingBTrades云函数操作





    - 根据A交易记录查找匹配的B交易记录
    - 确保股票代码相同、交易类型相反、数量相等
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_


- [x] 3. 创建新的T账单云函数操作










  - [x] 3.1 实现createTBill云函数操作


    - 使用数据库事务确保数据一致性
    - 创建T账单记录并更新关联交易记录状态
    - 计算并保存盈利金额和盈利率
    - _需求: 4.1, 4.2, 4.5, 4.6, 4.7_

  - [x] 3.2 实现updateTBill云函数操作

    - 支持编辑现有T账单的交易记录关联
    - 恢复原交易记录状态并更新新选择的交易记录状态
    - 使用事务确保操作原子性
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [x] 3.3 实现getTBillDetail云函数操作

    - 获取T账单详情及关联的交易记录信息
    - 用于编辑页面数据加载
    - _需求: 5.2_

- [x] 4. 修改交易记录前端页面








  - [x] 4.1 更新交易记录列表页面


    - 显示交易记录的匹配状态
    - 添加状态筛选功能（全部/未匹配/已匹配）
    - 使用不同视觉样式区分匹配状态
    - _需求: 6.1, 6.2, 6.3_

  - [x] 4.2 修改添加交易记录页面


    - 移除自动匹配相关的UI元素
    - 确保保存后交易记录状态为未匹配
    - _需求: 1.1, 1.2_

  - [x] 4.3 更新交易记录详情页面


    - 显示匹配状态信息
    - 如果已匹配，显示关联的T账单链接
    - 根据匹配状态控制编辑按钮的可用性
    - _需求: 1.4, 1.5, 6.4, 6.5_

- [x] 5. 创建交易记录选择组件





  - [x] 5.1 实现TradeSelector组件


    - 支持按交易类型筛选显示
    - 支持按数量筛选（用于B交易选择）
    - 支持排除指定ID的交易记录
    - 提供选择事件回调
    - _需求: 2.2, 2.3, 3.1, 3.2, 3.3, 3.4_

  - [x] 5.2 创建交易选择页面


    - 独立的页面用于选择交易记录
    - 支持搜索和筛选功能
    - 显示交易记录的详细信息
    - _需求: 2.1, 2.4_

- [x] 6. 重构T账单创建和编辑页面





  - [x] 6.1 修改T账单创建页面


    - 移除手动输入交易信息的表单
    - 添加A交易记录选择功能
    - 根据A交易动态显示B交易选择列表
    - 实时计算并显示盈利信息
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

  - [x] 6.2 修改T账单编辑页面


    - 加载现有T账单的交易记录关联
    - 支持重新选择A和B交易记录
    - 处理编辑过程中的状态恢复逻辑
    - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

  - [x] 6.3 更新T账单列表页面


    - 显示T账单的关联交易记录信息
    - 优化盈利信息的展示
    - _需求: 4.6, 4.7_

- [ ] 7. 实现数据库迁移
  - [ ] 7.1 为现有交易记录添加matchStatus字段
    - 创建数据迁移脚本
    - 为现有记录设置合适的默认值
    - _需求: 1.3_

  - [ ] 7.2 更新现有T账单数据结构
    - 添加aTradeId和bTradeId字段
    - 迁移现有的buyTradeId和sellTradeId数据
    - _需求: 4.5_

- [ ] 8. 添加数据库索引优化
  - 为trades集合添加复合索引 (_openid, matchStatus, type)
  - 为trades集合添加复合索引 (_openid, stockCode, matchStatus)
  - 为tbills集合添加索引 (aTradeId, bTradeId)
  - _设计文档: 数据库集合索引_

- [ ] 9. 实现错误处理和验证
  - [ ] 9.1 添加业务逻辑验证
    - 验证A和B交易记录的股票代码一致性
    - 验证A和B交易记录的数量一致性
    - 验证交易记录的匹配状态
    - _需求: 3.5, 4.3, 4.4_

  - [ ] 9.2 实现错误处理机制
    - 定义标准错误类型和错误码
    - 实现用户友好的错误信息显示
    - 添加操作失败时的回滚机制
    - _设计文档: 错误处理策略_

- [ ]* 10. 编写测试用例
  - [ ]* 10.1 编写云函数单元测试
    - 测试交易记录CRUD操作
    - 测试T账单创建和编辑逻辑
    - 测试数据验证和错误处理
    - _设计文档: 单元测试_

  - [ ]* 10.2 编写前端组件测试
    - 测试交易选择组件功能
    - 测试T账单表单组件
    - 测试用户交互流程
    - _设计文档: 前端组件测试_

  - [ ]* 10.3 编写集成测试
    - 测试完整的T账单创建流程
    - 测试交易记录状态变更流程
    - 测试并发操作和数据一致性
    - _设计文档: 集成测试_

- [-] 11. 性能优化和用户体验改进



  - [ ] 11.1 优化交易记录查询性能


    - 实现分页加载机制
    - 添加搜索和筛选缓存
    - 优化数据库查询语句
    - _设计文档: 性能测试_

  - [ ] 11.2 改进用户界面体验
    - 添加加载状态指示器
    - 实现操作确认对话框
    - 优化移动端交互体验
    - _需求: 4.7, 6.1, 6.2_

- [ ] 12. 文档和部署准备
  - [ ] 12.1 更新用户使用文档
    - 编写新功能使用说明
    - 更新操作流程文档
    - 创建常见问题解答

  - [ ] 12.2 准备生产环境部署
    - 验证云函数配置
    - 检查数据库权限设置
    - 准备数据迁移计划
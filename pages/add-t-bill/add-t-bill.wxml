<view class="container">
  <!-- 选择T账单类型 -->
  <view wx:if="{{selectingStep === 0}}" class="type-selection">
    <view class="section-title">选择T账单类型</view>
    <view class="type-option" data-type="buy-sell" bindtap="onSelectType">
      <text class="type-label">先买后卖</text>
      <text class="type-desc">先买入股票，再卖出相同数量的股票</text>
    </view>
    <view class="type-option" data-type="sell-buy" bindtap="onSelectType">
      <text class="type-label">先卖后买</text>
      <text class="type-desc">先卖出股票，再买入相同数量的股票</text>
    </view>
  </view>

  <!-- 选择交易 -->
  <view wx:elif="{{selectingStep >= 1}}" class="trade-selection">
    <!-- T账单信息概览 -->
    <view class="t-bill-summary">
      <view class="summary-row">
        <text class="label">类型:</text>
        <text class="value {{type}}">{{type === 'buy-sell' ? '先买后卖' : '先卖后买'}}</text>
      </view>
      <view class="summary-row">
        <text class="label">股票:</text>
        <text class="value">{{stockName}}({{stockCode}})</text>
      </view>
      <view class="summary-row">
        <text class="label">数量:</text>
        <text class="value">{{quantity}}</text>
      </view>
    </view>

    <!-- 第一步交易 -->
    <view class="trade-step">
      <view class="step-header">
        <text class="step-number">1</text>
        <text class="step-title">第一步交易</text>
        <text wx:if="{{firstTradeSelected}}" class="step-status completed">已完成</text>
        <text wx:else class="step-status pending">待完成</text>
      </view>
      
      <view wx:if="{{firstTradeSelected}}" class="selected-trade">
        <view class="trade-info">
          <text class="trade-type {{firstTrade.type}}">{{firstTrade.type === 'buy' ? '买入' : '卖出'}}</text>
          <text class="trade-price">¥{{firstTrade.price}}</text>
          <text class="trade-date">{{firstTrade.date}}</text>
        </view>
      </view>
      
      <view wx:else class="select-trade-button" bindtap="showTradeSelector" data-step="{{1}}">
        <text>选择交易记录</text>
      </view>
    </view>

    <!-- 第二步交易 -->
    <view class="trade-step">
      <view class="step-header">
        <text class="step-number">2</text>
        <text class="step-title">第二步交易</text>
        <text wx:if="{{secondTradeSelected}}" class="step-status completed">已完成</text>
        <text wx:else class="step-status pending">待完成</text>
      </view>
      
      <view wx:if="{{secondTradeSelected}}" class="selected-trade">
        <view class="trade-info">
          <text class="trade-type {{secondTrade.type}}">{{secondTrade.type === 'buy' ? '买入' : '卖出'}}</text>
          <text class="trade-price">¥{{secondTrade.price}}</text>
          <text class="trade-date">{{secondTrade.date}}</text>
        </view>
        
        <!-- 收益显示 -->
        <view class="profit-section">
          <view class="profit-row">
            <text class="label">本次做T收益:</text>
            <text class="profit-value {{profit >= 0 ? 'profit-positive' : 'profit-negative'}}">
              ¥{{profit}}
            </text>
          </view>
        </view>
      </view>
      
      <view wx:elif="{{firstTradeSelected}}" class="select-trade-button" bindtap="showTradeSelector" data-step="{{2}}">
        <text>选择交易记录</text>
      </view>
      
      <view wx:else class="select-trade-button disabled">
        <text>请先完成第一步</text>
      </view>
    </view>

    <!-- 操作按钮 -->
    <view class="action-buttons">
      <button wx:if="{{id}}" class="delete-button" bindtap="deleteTBill">删除</button>
      <button class="save-button" bindtap="saveTBill">保存</button>
    </view>
  </view>

  <!-- 交易选择器弹窗 -->
  <view wx:if="{{tradeSelectorVisible}}" class="trade-selector-overlay" bindtap="hideTradeSelector">
    <view class="trade-selector" catchtap="stopPropagation">
      <view class="selector-header">
        <text>选择交易记录</text>
        <view class="close-button" bindtap="hideTradeSelector">×</view>
      </view>
      
      <view wx:if="{{filteredTrades.length === 0}}" class="no-trades">
        <text>暂无符合条件的交易记录</text>
      </view>
      
      <scroll-view wx:else class="trades-list" scroll-y="true">
        <view wx:for="{{filteredTrades}}" wx:key="id" class="trade-item" data-trade="{{item}}" bindtap="selectTrade">
          <view class="trade-row">
            <text class="stock-name">{{item.stockName}}</text>
            <text class="trade-type {{item.type}}">{{item.type === 'buy' ? '买入' : '卖出'}}</text>
          </view>
          <view class="trade-details">
            <text>价格: ¥{{item.price}}</text>
            <text>数量: {{item.quantity}}</text>
            <text>{{item.date}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view>